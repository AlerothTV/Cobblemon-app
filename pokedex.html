<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link href="https://fonts.cdnfonts.com/css/minecraft-ia" rel="stylesheet">
    <title>Cobblemon Pokédex - Yellow Version</title>
    <style>
        :root { 
            --font-poke: 'Minecraft', 'Courier New', monospace;
            --sb-track-color: #3a96b6;
            --sb-thumb-color: #2e7891;
            --accent-color: #7ee7e5;
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100vh; overflow: hidden; background: grey; 
            font-family: var(--font-poke); letter-spacing: 1px;
            display: flex; justify-content: center; align-items: center;
        }

        .pokedex-container { 
            display: flex; flex-direction: column; height: calc(100vh - 40px); 
            width: calc(100vw - 40px); max-width: 1800px; image-rendering: pixelated; position: relative;
        }

        /* Structure Jaune */
        .row-top { display: flex; height: 74px; flex-shrink: 0; }  
        .top-1 { width: 101px; background: url("img/pokedex/jaune/jaune_03.png") no-repeat; }
        .top-2, .top-8 { flex-grow: 1; background: url("img/pokedex/jaune/jaune_05.png") repeat-x; }
        .top-3 { width: 48px; background: url("img/pokedex/jaune/jaune_06.png") no-repeat; }
        .top-4, .top-6 { flex-grow: 1; background: url("img/pokedex/jaune/jaune_07.png") repeat-x; }
        .top-5 { width: 24px; background: url("img/pokedex/jaune/jaune_09.png") no-repeat; }
        .top-7 { width: 48px; background: url("img/pokedex/jaune/jaune_11.png") no-repeat; }
        .top-9 { width: 101px; background: url("img/pokedex/jaune/jaune_13.png") no-repeat; }
        
        .row-middle { display: flex; flex-grow: 1; overflow: hidden; }
        .side-column { display: flex; flex-direction: column; width: 101px; flex-shrink: 0; }
        .side-repeat { flex-grow: 1; background-repeat: repeat-y; }
        .g-top { height: 131px; background-image: url("img/pokedex/jaune/jaune_15.png"); }
        .g-mid { background-image: url("img/pokedex/jaune/jaune_22.png"); }
        .g-bot { height: 131px; background-image: url("img/pokedex/jaune/jaune_24.png"); }
        .d-top { height: 131px; background-image: url("img/pokedex/jaune/jaune_19.png"); }
        .d-mid { background-image: url("img/pokedex/jaune/jaune_23.png"); }
        .d-bot { height: 131px; background-image: url("img/pokedex/jaune/jaune_25.png"); }

        .screen { 
            flex-grow: 1; background-color: #3a96b6; overflow-y: auto; padding: 20px; 
            border: 3px solid #7ee7e5; outline: 10px solid #3a96b6; margin-top: 10px;
        }

        /* Filtres */
        .filter-bar { 
            background: rgba(0,0,0,0.3); padding: 12px; margin-bottom: 20px; 
            display: flex; flex-wrap: wrap; gap: 10px; border-radius: 4px; color: white; align-items: center;
        }
        .filter-group { display: flex; align-items: center; gap: 5px; font-size: 11px; }
        .filter-bar select, .filter-bar input, .filter-bar button {
            background: #7ee7e5; border: 2px solid #2e7891; padding: 5px; font-family: sans-serif; font-weight: bold; font-size: 12px;
        }
        .filter-active { background: #ffd700 !important; color: black !important; }

        .counter-box { margin-left: auto; display: flex; align-items: center; gap: 8px; background: rgba(0,0,0,0.4); padding: 5px 12px; border-radius: 20px; }
        .counter-icon { width: 20px; height: 20px; background: url("img/pokedex/caught_seen_icon.png") no-repeat; background-size: 20px auto; background-position: 0 -20px; }

        /* Grille & Cartes */
        .pokedex-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; }
        .slot { display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; transition: 0.2s; }
        .slot:hover { transform: translateY(-5px); }
        .slot-background { background: #70dfe8; border: 4px solid #84feff; padding: 15px; width: 120px; text-align: center; box-shadow: 4px 4px 0px rgba(0,0,0,0.2); position: relative; border-radius: 6px; }
        
        /* Silhouettes */
        .not-caught img { filter: brightness(0); opacity: 0.6; }
        .slot img { width: 100px; height: 100px; object-fit: contain; image-rendering: pixelated; }
        .slot-name { margin-top: 10px; color: white; text-shadow: 2px 2px 0px #000; text-transform: uppercase; font-size: 11px; width: 140px; text-align: center; }

        .catch-trigger { position: absolute; top: -8px; right: -8px; width: 32px; height: 32px; background: url("img/pokedex/caught_seen_icon.png") no-repeat; background-size: 32px auto; z-index: 5; }
        .is-caught .catch-trigger { background-position: 0 -32px; }
        .is-caught .slot-background { background: #c18e27; border-color: #fae05d; }

        /* Types */
        .types-container { display: flex; justify-content: center; gap: 3px; margin-top: 5px; height: 30px; }
        .type-icon { width: 30px; height: 30px; background-image: url("img/pokedex/types.png"); background-size: auto 30px; background-repeat: no-repeat; }

        .row-bottom { display: flex; height: 61px; flex-shrink: 0; }
        .bot-1 { width: 101px; background: url("img/pokedex/jaune/jaune_26.png") no-repeat; }
        .bot-2, .bot-4 { flex-grow: 1; background: url("img/pokedex/jaune/jaune_27.png") repeat-x; }
        .bot-3 { width: 24px; background: url("img/pokedex/jaune/jaune_29.png") no-repeat; }
        .bot-5 { width: 101px; background: url("img/pokedex/jaune/jaune_30.png") no-repeat; }

        .screen::-webkit-scrollbar { width: 10px; }
        .screen::-webkit-scrollbar-thumb { background: var(--sb-thumb-color); border: 2px solid var(--accent-color); }
    </style>
</head>
<body>

<div class="pokedex-container">
    <div class="row-top">
        <div class="top-1"></div><div class="top-2"></div><div class="top-3"></div><div class="top-4"></div><div class="top-5"></div><div class="top-6"></div><div class="top-7"></div><div class="top-8"></div><div class="top-9"></div>
    </div>
    <div class="row-middle">
        <div class="side-column"><div class="g-top"></div><div class="side-repeat g-mid"></div><div class="g-bot"></div></div>
        <div class="screen">
            <div class="filter-bar" id="filters"></div>
            <div class="pokedex-grid" id="grid"></div>
        </div>
        <div class="side-column"><div class="d-top"></div><div class="side-repeat d-mid"></div><div class="d-bot"></div></div>
    </div>
    <div class="row-bottom">
        <div class="bot-1"></div><div class="bot-2"></div><div class="bot-3"></div><div class="bot-4"></div><div class="bot-5"></div>
    </div>
</div>

<script>
    const TYPE_ORDER = ["normal","fire","water","grass","electric","ice","fighting","poison","ground","flying","psychic","bug","rock","ghost","dragon","dark","steel","fairy"];
    
    let pokedex = [];
    let translations = {};
    let currentLang = localStorage.getItem('lang') || 'fr';
    let caught = JSON.parse(localStorage.getItem('caught') || "[]").map(String);
    let showOnlyMissing = false;

    // Fonction de traduction robuste
function t(cat, key) {
    if (!key) return "";
    const k = key.toLowerCase();
    
    // 1. Chercher dans la catégorie spécifique (ex: translations['ui']['label_search'])
    if (translations[cat] && translations[cat][k]) {
        const entry = translations[cat][k];
        return currentLang === 'fr' ? (entry.fr || key) : (entry.en || key);
    }
    
    // 2. Si non trouvé, chercher à la racine au cas où (fallback)
    if (translations[k]) {
        const entry = translations[k];
        return currentLang === 'fr' ? (entry.fr || key) : (entry.en || key);
    }

    return key; // Retourne la clé brute si rien n'est trouvé
}

async function init() {
    try {
        const [dataRes, transRes, uiRes] = await Promise.all([
            fetch('Data/pokedex_data.json'),
            fetch('Data/translations_data.json'),
            fetch('Data/translations_ui.json')
        ]);
        
        pokedex = await dataRes.json();
        const pTrans = await transRes.json();
        const uTrans = await uiRes.json();
        
        // Fusion profonde
        translations = Object.assign({}, pTrans, uTrans);

        buildFilters();
        render();
    } catch (e) { 
        console.error("Erreur de chargement JSON:", e); 
    }
}

    function makeOptions(category) {
        let html = `<option value="all">${t('ui', 'Label_All')}</option>`;
        if (translations[category]) {
            Object.keys(translations[category]).forEach(key => {
                html += `<option value="${key}">${t(category, key)}</option>`;
            });
        }
        return html;
    }

    function buildFilters() {
        const f = document.getElementById('filters');
        const totalImpl = pokedex.filter(p => p.implemented === true).length;
        
        f.innerHTML = `
            <input type="text" id="searchInput" placeholder="${t('ui','Label_search')}..." oninput="render()">
            
            <select onchange="currentLang=this.value; localStorage.setItem('lang',this.value); buildFilters(); render();">
                <option value="fr" ${currentLang==='fr'?'selected':''}>FR</option>
                <option value="en" ${currentLang==='en'?'selected':''}>EN</option>
            </select>

            <div class="filter-group"><span>${t('ui','Label_Generation')}:</span><select id="fGen" onchange="render()">${makeOptions('Generation')}</select></div>
            <div class="filter-group"><span>${t('ui','Label_Type')}:</span><select id="fType" onchange="render()">${makeOptions('Type')}</select></div>
            <div class="filter-group"><span>${t('ui','Label_EggGroup')}:</span><select id="fEgg" onchange="render()">${makeOptions('EggGroup')}</select></div>
            <div class="filter-group"><span>${t('ui','Label_Evolution')}:</span><select id="fEvo" onchange="render()">${makeOptions('Evolution')}</select></div>
            <div class="filter-group"><span>${t('ui','Label_Others')}:</span><select id="fOth" onchange="render()">${makeOptions('Others')}</select></div>

            <button onclick="showOnlyMissing=!showOnlyMissing; this.classList.toggle('filter-active'); render();" class="${showOnlyMissing?'filter-active':''}">
                ${t('ui','Label_Captured')}: ${showOnlyMissing ? 'MISSING' : 'ALL'}
            </button>

            <div class="counter-box">
                <div class="counter-icon"></div>
                <span>${caught.length} / ${totalImpl}</span>
            </div>
        `;
    }

    function render() {
        const grid = document.getElementById('grid');
        const query = document.getElementById('searchInput')?.value.toLowerCase() || "";
        const fGen = document.getElementById('fGen')?.value || "all";
        const fType = document.getElementById('fType')?.value || "all";
        const fEgg = document.getElementById('fEgg')?.value || "all";
        const fEvo = document.getElementById('fEvo')?.value || "all";
        const fOth = document.getElementById('fOth')?.value || "all";

        grid.innerHTML = "";
        
        pokedex.forEach(p => {
            if (p.implemented !== true) return;

            const name = t('pokemon', p.name);
            const isC = caught.includes(String(p.id));

            if (showOnlyMissing && isC) return;
            if (query && !name.toLowerCase().includes(query) && !String(p.id).includes(query)) return;
            if (fGen !== "all" && !p.labels.includes(fGen)) return;
            if (fType !== "all" && !p.types.includes(fType)) return;
            if (fEgg !== "all" && !p.eggGroups.includes(fEgg)) return;
            if (fOth !== "all" && !p.labels.includes(fOth)) return;

            if (fEvo !== "all") {
                const hasMethod = p.evolutions.some(e => 
                    e.condition.toLowerCase().replace(/\s+/g, '_').includes(fEvo)
                );
                if (!hasMethod) return;
            }

            const card = document.createElement('div');
            card.className = `slot ${isC ? 'is-caught' : 'not-caught'}`;
            
            const type1Pos = TYPE_ORDER.indexOf(p.types[0]) * -30;
            const type2Html = p.types[1] ? `<div class="type-icon" style="background-position:${TYPE_ORDER.indexOf(p.types[1]) * -30}px 0"></div>` : '';

            card.innerHTML = `
                <div class="slot-background">
                    <div class="catch-trigger" onclick="event.stopPropagation(); toggleCatch('${p.id}')"></div>
                    <img src="img/pokemon/${p.id}.webp" onerror="this.src='img/pokemon/0.webp'">
                    <div style="font-size:16px; color:white; margin-top:5px;">#${p.id}</div>
                    <div class="types-container">
                        <div class="type-icon" style="background-position:${type1Pos}px 0"></div>
                        ${type2Html}
                    </div>
                </div>
                <div class="slot-name">${name}</div>
            `;
            grid.appendChild(card);
        });
    }

    function toggleCatch(id) {
        id = String(id);
        if(caught.includes(id)) caught = caught.filter(i => i !== id);
        else caught.push(id);
        localStorage.setItem('caught', JSON.stringify(caught));
        render();
        buildFilters();
    }

    init();
</script>
</body>
</html>